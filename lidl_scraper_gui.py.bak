"""
Lidl Receipt Downloader - GUI Version
–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑—Ç–µ–≥–ª—è –≤—Å–∏—á–∫–∏ –∫–∞—Å–æ–≤–∏ –±–µ–ª–µ–∂–∫–∏ –æ—Ç Lidl.bg
"""

import asyncio
import os
import threading
import json
import base64
from datetime import datetime
from pathlib import Path
import tkinter as tk
from tkinter import ttk, filedialog, scrolledtext, messagebox
from playwright.async_api import async_playwright, TimeoutError as PlaywrightTimeout



class LidlReceiptDownloader:
    def __init__(self, output_dir: str, start_date=None, end_date=None, log_callback=None, progress_callback=None):
        self.output_dir = output_dir
        self.start_date = start_date
        self.end_date = end_date
        self.receipts = []
        self.log_callback = log_callback
        self.progress_callback = progress_callback
        self.is_cancelled = False
        self.ready_to_start = False
        self.total_pages_estimated = 1
        self.current_page_processed = 0
        
    def log(self, message):
        """–õ–æ–≥–≤–∞–Ω–µ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏–µ"""
        if self.log_callback:
            self.log_callback(message)
        print(message)
    
    async def login(self, page):
        """–í–ª–∏–∑–∞ –≤ –∞–∫–∞—É–Ω—Ç–∞"""
        self.log("–í–ª–∏–∑–∞–Ω–µ –≤ –∞–∫–∞—É–Ω—Ç–∞...")
        
        try:
            await page.goto('https://accounts.lidl.com/Account/Login?ReturnUrl=%2Fconnect%2Fauthorize%2Fcallback%3Fcountry_code%3DBG%26response_type%3Dcode%26client_id%3Dbulgariaretailclient%26scope%3Dopenid%2520profile%2520Lidl.Authentication%2520offline_access%26state%3D7kjyF6Xd4NaMWmVqiNhXmDlKvTzcOa23tPkuFORkF2E%253D%26redirect_uri%3Dhttps%253A%252F%252Fwww.lidl.bg%252Fuser-api%252Fsignin-oidc%26nonce%3DEJIGNwoTYnT5BTScAf8yndJ6_tfF5V-ag26aqBsTg-8%26step%3Dlogin%26language%3Dbg-BG#login', wait_until='networkidle')
            await asyncio.sleep(00)
            
            await page.fill('input[type="email"], input[name="email"], input[id="email"]', self.email)
            await asyncio.sleep(1)
            
            await page.fill('input[type="password"], input[name="password"], input[id="password"]', self.password)
            await asyncio.sleep(1)
            
            await page.click('button[type="submit"], input[type="submit"]')
            await asyncio.sleep(3)
            
            await page.wait_for_load_state('networkidle')
            self.log("‚úì –£—Å–ø–µ—à–Ω–æ –≤–ª–∏–∑–∞–Ω–µ!")
            
        except Exception as e:
            self.log(f"‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤–ª–∏–∑–∞–Ω–µ: {e}")
            raise
    
    def parse_receipt_date(self, text_content):
        """–ò–∑–≤–ª–∏—á–∞ –¥–∞—Ç–∞—Ç–∞ –æ—Ç –∫–∞—Å–æ–≤–∞—Ç–∞ –±–µ–ª–µ–∂–∫–∞"""
        try:
            import re
            # –¢—ä—Ä—Å–∏–º –¥–∞—Ç–∞ –≤—ä–≤ —Ñ–æ—Ä–º–∞—Ç DD.MM.YYYY HH:MM:SS
            date_pattern = r'(\d{2}\.\d{2}\.\d{4})\s+(\d{2}:\d{2}:\d{2})'
            match = re.search(date_pattern, text_content)
            if match:
                date_str = match.group(1)
                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–∞–º–µ –≤—ä–≤ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD –∑–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
                parts = date_str.split('.')
                return f"{parts[2]}-{parts[1]}-{parts[0]}"
        except:
            pass
        return None
    
    def is_date_in_range(self, receipt_date_str):
        """–ü—Ä–æ–≤–µ—Ä—è–≤–∞ –¥–∞–ª–∏ –¥–∞—Ç–∞—Ç–∞ –µ –≤ –∏–∑–±—Ä–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥"""
        if not self.start_date and not self.end_date:
            return True
        
        if not receipt_date_str:
            return True  # –ê–∫–æ –Ω–µ –º–æ–∂–µ–º –¥–∞ –∏–∑–≤–ª–µ—á–µ–º –¥–∞—Ç–∞, –≤–∫–ª—é—á–≤–∞–º–µ –±–µ–ª–µ–∂–∫–∞—Ç–∞
        
        try:
            if self.start_date and receipt_date_str < self.start_date:
                return False
            if self.end_date and receipt_date_str > self.end_date:
                return False
            return True
        except:
            return True
    
    async def navigate_to_purchase_history(self, page, page_num=1):
        """–û—Ç–∏–≤–∞ –¥–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ —Å –ø–æ–∫—É–ø–∫–∏"""
        url = f'https://www.lidl.bg/mre/purchase-history?client_id=BulgariaRetailClient&country_code=bg&language=bg-BG&page={page_num}'
        self.log(f"–û—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—è –Ω–∞ –ø–æ–∫—É–ø–∫–∏—Ç–µ (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ {page_num})...")
        await page.goto(url, wait_until='networkidle')
        await asyncio.sleep(2)
    
    async def extract_receipts_from_page(self, page, page_number):
        """–ò–∑–≤–ª–∏—á–∞ –∫–∞—Å–æ–≤–∏—Ç–µ –±–µ–ª–µ–∂–∫–∏ –æ—Ç —Ç–µ–∫—É—â–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
        self.log("–ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –∫–∞—Å–æ–≤–∏ –±–µ–ª–µ–∂–∫–∏...")
        
        try:
            await asyncio.sleep(3)
            
            purchase_selectors = [
                'a[href*="/mre/purchase-detail"]',
                'a.card[href*="purchase-detail"]',
                'a[data-testid][class*="card"]',
                'a.card',
                'a[class*="card"][href*="/mre/"]'
            ]
            
            purchase_elements = []
            for selector in purchase_selectors:
                elements = await page.query_selector_all(selector)
                if elements:
                    purchase_elements = elements
                    self.log(f"–ò–∑–ø–æ–ª–∑–≤–∞–Ω —Å–µ–ª–µ–∫—Ç–æ—Ä: {selector}")
                    break
            
            if not purchase_elements:
                purchase_elements = await page.query_selector_all('button, a[href*="purchase"], a[href*="receipt"]')
            
            self.log(f"–ù–∞–º–µ—Ä–µ–Ω–∏ {len(purchase_elements)} –ø–æ–∫—É–ø–∫–∏ –Ω–∞ —Ç–∞–∑–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞")
            
            for i in range(len(purchase_elements)):
                if self.is_cancelled:
                    self.log("‚ö† –ü—Ä–æ—Ü–µ—Å—ä—Ç –µ –ø—Ä–µ–∫—ä—Å–Ω–∞—Ç –æ—Ç –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è")
                    return
                
                try:
                    self.log(f"  –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –ø–æ–∫—É–ø–∫–∞ {i + 1}/{len(purchase_elements)}...")
                    
                    await asyncio.sleep(1)
                    used_selector = 'a.card[href*="purchase-detail"]'
                    for selector in purchase_selectors:
                        test_elements = await page.query_selector_all(selector)
                        if test_elements:
                            used_selector = selector
                            break
                    current_elements = await page.query_selector_all(used_selector)
                    
                    if i >= len(current_elements):
                        self.log(f"  –ï–ª–µ–º–µ–Ω—Ç {i + 1} –≤–µ—á–µ –Ω–µ –µ –¥–æ—Å—Ç—ä–ø–µ–Ω, –ø—Ä–µ—Å–∫–∞—á–∞–Ω–µ...")
                        continue
                    
                    element = current_elements[i]
                    
                    await element.scroll_into_view_if_needed()
                    await asyncio.sleep(0.5)
                    
                    await element.click()
                    await asyncio.sleep(2)
                    
                    await page.wait_for_load_state('networkidle', timeout=10000)
                    await asyncio.sleep(2)
                    
                    # –ò–∑—á–∞–∫–≤–∞–Ω–µ –∑–∞ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –±–µ–ª–µ–∂–∫–∞—Ç–∞
                    await asyncio.sleep(1)
                    
                    receipt_selectors = [
                        'main',
                        'body'
                    ]
                    
                    text_content = None
                    for selector in receipt_selectors:
                        receipt_container = await page.query_selector(selector)
                        if receipt_container:
                            text_content = await receipt_container.inner_text()
                            if text_content and len(text_content.strip()) > 100:
                                break
                    
                    if not text_content:
                        text_content = await page.inner_text('body')
                    
                    # –ü–æ—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ –Ω–µ–Ω—É–∂–µ–Ω —Ç–µ–∫—Å—Ç –æ—Ç navigation –∏ footer
                    if text_content:
                        # –ò–∑–≤–ª–∏—á–∞–º–µ —Å–∞–º–æ –æ—Å–Ω–æ–≤–Ω–æ—Ç–æ —Å—ä–¥—ä—Ä–∂–∞–Ω–∏–µ –Ω–∞ –±–µ–ª–µ–∂–∫–∞—Ç–∞
                        lines = text_content.split('\n')
                        # –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ –ø—ä—Ä–≤–∏—Ç–µ —Ä–µ–¥–æ–≤–µ –∞–∫–æ —Å–∞ navigation
                        cleaned_lines = []
                        start_found = False
                        for line in lines:
                            # –¢—ä—Ä—Å–∏–º –Ω–∞—á–∞–ª–æ –Ω–∞ –±–µ–ª–µ–∂–∫–∞—Ç–∞ (–æ–±–∏–∫–Ω–æ–≤–µ–Ω–æ —Å—ä—Å –ë–£–õ–°–¢–ê–¢ –∏–ª–∏ –∞–¥—Ä–µ—Å –Ω–∞ –º–∞–≥–∞–∑–∏–Ω)
                            if '–ë–£–õ–°–¢–ê–¢' in line or '–£–ù–ü' in line or '–õ–∏–¥–ª' in line or not start_found:
                                start_found = True
                            if start_found:
                                cleaned_lines.append(line)
                        text_content = '\n'.join(cleaned_lines).strip()
                    
                    if text_content and text_content.strip():
                        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–∞—Ç–∞—Ç–∞
                        receipt_date = self.parse_receipt_date(text_content)
                        
                        if self.is_date_in_range(receipt_date):
                            receipt_data = {
                                'page_number': page_number,
                                'index': i + 1,
                                'date': receipt_date,
                                'content': text_content.strip()
                            }
                            self.receipts.append(receipt_data)
                            date_info = f" ({receipt_date})" if receipt_date else ""
                            self.log(f"    ‚úì –ò–∑–≤–ª–µ—á–µ–Ω–∞ –±–µ–ª–µ–∂–∫–∞ {i + 1}{date_info} ({len(text_content)} —Å–∏–º–≤–æ–ª–∞)")
                            self.log(f"    üìä –û–±—â–æ –∏–∑—Ç–µ–≥–ª–µ–Ω–∏ –±–µ–ª–µ–∂–∫–∏: {len(self.receipts)}")
                        else:
                            date_info = f" ({receipt_date})" if receipt_date else ""
                            self.log(f"    ‚äó –ü—Ä–æ–ø—É—Å–Ω–∞—Ç–∞ –±–µ–ª–µ–∂–∫–∞ {i + 1}{date_info} - –∏–∑–≤—ä–Ω –ø–µ—Ä–∏–æ–¥")
                    else:
                        self.log(f"    ‚ö† –ë–µ–ª–µ–∂–∫–∞ {i + 1} –µ –ø—Ä–∞–∑–Ω–∞")
                    
                    await page.go_back()
                    await asyncio.sleep(2)
                    await page.wait_for_load_state('networkidle', timeout=10000)
                    
                except PlaywrightTimeout:
                    self.log(f"  Timeout –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –ø–æ–∫—É–ø–∫–∞ {i + 1}, –ø—Ä–æ–¥—ä–ª–∂–∞–≤–∞–Ω–µ...")
                    try:
                        await page.go_back()
                        await asyncio.sleep(2)
                    except:
                        pass
                except Exception as e:
                    self.log(f"  –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –ø–æ–∫—É–ø–∫–∞ {i + 1}: {e}")
                    try:
                        await page.go_back()
                        await asyncio.sleep(2)
                    except:
                        pass
                    continue
                    
        except Exception as e:
            self.log(f"–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –±–µ–ª–µ–∂–∫–∏: {e}")
    
    async def has_more_receipts(self, page):
        """–ü—Ä–æ–≤–µ—Ä—è–≤–∞ –¥–∞–ª–∏ –∏–º–∞ –æ—â–µ –±–µ–ª–µ–∂–∫–∏ (–ø–æ–∫—É–ø–∫–∏) –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞"""
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –ø–æ–∫—É–ø–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞
            purchase_links = await page.query_selector_all('a[href*="/mre/purchase-detail"]')
            return len(purchase_links) > 0
        except Exception:
            return False
    
    async def check_current_page_number(self, page):
        """–ò–∑–≤–ª–∏—á–∞ —Ç–µ–∫—É—â–∏—è –Ω–æ–º–µ—Ä –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ –æ—Ç URL"""
        try:
            current_url = page.url
            if 'page=' in current_url:
                page_param = current_url.split('page=')[1].split('&')[0]
                return int(page_param)
            return 1
        except:
            return 1
    
    async def download_all_receipts(self):
        """–ò–∑—Ç–µ–≥–ª—è –≤—Å–∏—á–∫–∏ –∫–∞—Å–æ–≤–∏ –±–µ–ª–µ–∂–∫–∏"""
        async with async_playwright() as p:
            self.log("–°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä...")
            
            browser = await p.chromium.launch(headless=False)
            context = await browser.new_context(
                viewport={'width': 1920, 'height': 1080},
                user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            )
            page = await context.new_page()
            
            try:
                await self.wait_for_user_ready(page)
                
                # –ü–æ–ª—É—á–∞–≤–∞–º–µ —Ç–µ–∫—É—â–∏—è URL –∑–∞ –¥–∞ –æ–ø—Ä–µ–¥–µ–ª–∏–º –Ω–∞—á–∞–ª–Ω–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
                current_url = page.url
                page_number = await self.check_current_page_number(page)
                while not self.is_cancelled:
                    self.log(f"\n{'=' * 60}")
                    self.log(f"–°–¢–†–ê–ù–ò–¶–ê {page_number}")
                    self.log(f"{'=' * 60}")
                    
                    # –û—Ç–≤–∞—Ä—è–Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞ —Å –ø–æ–∫—É–ø–∫–∏
                    await self.navigate_to_purchase_history(page, page_number)
                    
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ –∏–º–∞ –ø–æ–∫—É–ø–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞
                    if not await self.has_more_receipts(page):
                        self.log(f"\n‚úì –ù—è–º–∞ –ø–æ–≤–µ—á–µ –ø–æ–∫—É–ø–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ {page_number}")
                        break
                    
                    receipts_before = len(self.receipts)
                    await self.extract_receipts_from_page(page, page_number)
                    receipts_after = len(self.receipts)
                    
                    self.current_page_processed = page_number
                    if self.progress_callback:
                        progress_percent = min(100, (page_number / self.total_pages_estimated) * 100)
                        self.progress_callback(progress_percent, page_number, self.total_pages_estimated)
                    
                    if self.is_cancelled:
                        self.log("\n‚ö† –ü—Ä–æ—Ü–µ—Å—ä—Ç –µ –ø—Ä–µ–∫—ä—Å–Ω–∞—Ç")
                        break
                    
                    self.log(f"\nüìã –ò–∑—Ç–µ–≥–ª–µ–Ω–∏ –æ—Ç —Ç–∞–∑–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞: {receipts_after - receipts_before}")
                    self.log(f"üìä –û–±—â–æ –∏–∑—Ç–µ–≥–ª–µ–Ω–∏ –±–µ–ª–µ–∂–∫–∏: {receipts_after}")
                    
                    # –ü—Ä–µ–º–∏–Ω–∞–≤–∞–º–µ –∫—ä–º —Å–ª–µ–¥–≤–∞—â–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞
                    page_number += 1
                
                if not self.is_cancelled:
                    self.log(f"\n{'=' * 60}")
                    self.log(f"‚úì –ü–†–ò–ö–õ–Æ–ß–ï–ù–û –ò–ó–¢–ï–ì–õ–Ø–ù–ï")
                    self.log(f"{'=' * 60}")
                    self.log(f"üìä –û–±—â–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏ –±–µ–ª–µ–∂–∫–∏: {len(self.receipts)}")
                    self.log(f"{'=' * 60}")
                
            except Exception as e:
                self.log(f"‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç–µ–≥–ª—è–Ω–µ: {e}")
                raise
                
            finally:
                await browser.close()
    
    def save_to_file(self):
        """–ó–∞–ø–∞–∑–≤–∞ –±–µ–ª–µ–∂–∫–∏—Ç–µ –≤—ä–≤ —Ñ–∞–π–ª"""
        timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
        filename = f'lidl_receipts_{timestamp}.txt'
        filepath = os.path.join(self.output_dir, filename)
        
        full_path = os.path.abspath(filepath)
        
        self.log(f"\n{'=' * 80}")
        self.log(f"üìù –ó–ê–ü–ê–ó–í–ê–ù–ï –ù–ê –ë–ï–õ–ï–ñ–ö–ò")
        self.log(f"{'=' * 80}")
        self.log(f"–ë—Ä–æ–π –±–µ–ª–µ–∂–∫–∏: {len(self.receipts)}")
        self.log(f"–§–∞–π–ª: {filename}")
        self.log(f"–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {self.output_dir}")
        self.log(f"–ü—ä–ª–µ–Ω –ø—ä—Ç: {full_path}")
        self.log(f"{'=' * 80}")
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write("=" * 80 + "\n")
            f.write("–ö–ê–°–û–í–ò –ë–ï–õ–ï–ñ–ö–ò –û–¢ LIDL.BG\n")
            f.write(f"–î–∞—Ç–∞ –Ω–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ: {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}\n")
            f.write(f"–û–±—â–æ –±–µ–ª–µ–∂–∫–∏: {len(self.receipts)}\n")
            f.write("=" * 80 + "\n\n")
            
            for i, receipt in enumerate(self.receipts, 1):
                f.write(f"\n{'=' * 80}\n")
                f.write(f"–ë–ï–õ–ï–ñ–ö–ê #{i}\n")
                f.write(f"–°—Ç—Ä–∞–Ω–∏—Ü–∞: {receipt['page_number']}\n")
                f.write(f"{'=' * 80}\n\n")
                f.write(receipt['content'])
                f.write("\n\n")
        
        file_size = os.path.getsize(full_path) / 1024  # KB
        
        self.log(f"\n{'=' * 80}")
        self.log(f"‚úÖ –£–°–ü–ï–®–ù–û –ó–ê–í–™–†–®–ï–ù–û!")
        self.log(f"{'=' * 80}")
        self.log(f"üìä –û–±—â–æ –±–µ–ª–µ–∂–∫–∏: {len(self.receipts)}")
        self.log(f"üìÅ –§–∞–π–ª: {filename}")
        self.log(f"üìÇ –ü—ä–ª–µ–Ω –ø—ä—Ç: {full_path}")
        self.log(f"üíæ –†–∞–∑–º–µ—Ä: {file_size:.2f} KB")
        self.log(f"{'=' * 80}")
        
        return full_path


class LidlGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("Lidl Receipt Downloader")
        self.root.geometry("800x750")
        self.root.resizable(True, True)
        
        self.downloader = None
        self.download_thread = None
        self.output_dir = str(Path.home() / "Documents")
        self.config_manager = ConfigManager()
        self.manual_login_mode = False
        
        self.setup_ui()
        self.load_saved_config()
        
    def setup_ui(self):
        """–°—ä–∑–¥–∞–≤–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        # –ó–∞–≥–ª–∞–≤–∏–µ
        title_frame = ttk.Frame(self.root, padding="10")
        title_frame.grid(row=0, column=0, sticky=(tk.W, tk.E))
        
        title_label = ttk.Label(
            title_frame, 
            text="Lidl Receipt Downloader", 
            font=("Arial", 16, "bold")
        )
        title_label.grid(row=0, column=0, pady=5)
        
        subtitle_label = ttk.Label(
            title_frame, 
            text="–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∏–∑—Ç–µ–≥–ª—è–Ω–µ –Ω–∞ –∫–∞—Å–æ–≤–∏ –±–µ–ª–µ–∂–∫–∏ –æ—Ç Lidl.bg",
            font=("Arial", 10)
        )
        subtitle_label.grid(row=1, column=0, pady=2)
        
        # –†–∞–º–∫–∞ –∑–∞ credentials
        cred_frame = ttk.LabelFrame(self.root, text="–î–∞–Ω–Ω–∏ –∑–∞ –≤—Ö–æ–¥", padding="10")
        cred_frame.grid(row=1, column=0, sticky=(tk.W, tk.E), padx=10, pady=5)
        
        ttk.Label(cred_frame, text="–ò–º–µ–π–ª:").grid(row=0, column=0, sticky=tk.W, pady=5)
        self.email_entry = ttk.Entry(cred_frame, width=50)
        self.email_entry.grid(row=0, column=1, sticky=(tk.W, tk.E), pady=5, padx=5)
        
        ttk.Label(cred_frame, text="–ü–∞—Ä–æ–ª–∞:").grid(row=1, column=0, sticky=tk.W, pady=5)
        self.password_entry = ttk.Entry(cred_frame, width=50, show="*")
        self.password_entry.grid(row=1, column=1, sticky=(tk.W, tk.E), pady=5, padx=5)
        
        cred_frame.columnconfigure(1, weight=1)
        
        # Checkbox –∑–∞ –∑–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ
        self.save_config_var = tk.BooleanVar(value=True)
        save_check = ttk.Checkbutton(
            cred_frame,
            text="üíæ –ó–∞–ø–∞–∑–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ",
            variable=self.save_config_var
        )
        save_check.grid(row=2, column=1, sticky=tk.W, pady=5)
        
        # Checkbox –∑–∞ —Ä—ä—á–Ω–æ –≤–ª–∏–∑–∞–Ω–µ
        self.manual_login_var = tk.BooleanVar(value=False)
        manual_login_check = ttk.Checkbutton(
            cred_frame,
            text="üë§ –†—ä—á–Ω–æ –≤–ª–∏–∑–∞–Ω–µ (–≤–ª–∏–∑–∞–º –∞–∑ –≤ –±—Ä–∞—É–∑—ä—Ä–∞)",
            variable=self.manual_login_var,
            command=self.toggle_manual_login
        )
        manual_login_check.grid(row=3, column=1, sticky=tk.W, pady=5)
        
        # –†–∞–º–∫–∞ –∑–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
        dir_frame = ttk.LabelFrame(self.root, text="–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ —Å—ä—Ö—Ä–∞–Ω–µ–Ω–∏–µ", padding="10")
        dir_frame.grid(row=2, column=0, sticky=(tk.W, tk.E), padx=10, pady=5)
        
        self.dir_label = ttk.Label(dir_frame, text=self.output_dir, foreground="blue")
        self.dir_label.grid(row=0, column=0, sticky=(tk.W, tk.E), pady=5)
        
        self.dir_button = ttk.Button(
            dir_frame, 
            text="üìÅ –ò–∑–±–µ—Ä–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è", 
            command=self.choose_directory
        )
        self.dir_button.grid(row=0, column=1, padx=5)
        
        dir_frame.columnconfigure(0, weight=1)
        
        # –†–∞–º–∫–∞ –∑–∞ –∫–æ–Ω—Ç—Ä–æ–ª–∏
        control_frame = ttk.Frame(self.root, padding="10")
        control_frame.grid(row=3, column=0, sticky=(tk.W, tk.E), padx=10, pady=5)
        
        self.start_button = ttk.Button(
            control_frame, 
            text="‚ñ∂ –°—Ç–∞—Ä—Ç", 
            command=self.start_download,
            style="Accent.TButton"
        )
        self.start_button.grid(row=0, column=0, padx=5)
        
        self.stop_button = ttk.Button(
            control_frame, 
            text="‚è∏ –ü—Ä–µ–∫—ä—Å–≤–∞–Ω–µ", 
            command=self.stop_download,
            state=tk.DISABLED
        )
        self.stop_button.grid(row=0, column=1, padx=5)
        
        self.continue_button = ttk.Button(
            control_frame, 
            text="‚úì –ü—Ä–æ–¥—ä–ª–∂–∏ —Å–ª–µ–¥ –ª–æ–≥–∏–Ω", 
            command=self.continue_after_login,
            state=tk.DISABLED,
            style="Accent.TButton"
        )
        self.continue_button.grid(row=0, column=2, padx=5)
        
        # –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä
        self.progress = ttk.Progressbar(
            control_frame, 
            mode='indeterminate',
            length=200
        )
        self.progress.grid(row=0, column=3, padx=10)
        
        # –°—Ç–∞—Ç—É—Å –ª–µ–π–±—ä–ª
        self.status_label = ttk.Label(
            control_frame, 
            text="–ì–æ—Ç–æ–≤ –∑–∞ —Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ",
            foreground="green"
        )
        self.status_label.grid(row=0, column=4, padx=5)
        
        # –†–∞–º–∫–∞ –∑–∞ –ª–æ–≥–æ–≤–µ
        log_frame = ttk.LabelFrame(self.root, text="–ü—Ä–æ–≥—Ä–µ—Å –∏ –ª–æ–≥–æ–≤–µ", padding="10")
        log_frame.grid(row=4, column=0, sticky=(tk.W, tk.E, tk.N, tk.S), padx=10, pady=5)
        
        self.log_text = scrolledtext.ScrolledText(
            log_frame, 
            height=20, 
            width=80,
            font=("Consolas", 9)
        )
        self.log_text.grid(row=0, column=0, sticky=(tk.W, tk.E, tk.N, tk.S))
        
        log_frame.columnconfigure(0, weight=1)
        log_frame.rowconfigure(0, weight=1)
        
        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–∞ grid weights
        self.root.columnconfigure(0, weight=1)
        self.root.rowconfigure(4, weight=1)
        
        # –°—Ç–∏–ª–æ–≤–µ
        style = ttk.Style()
        try:
            style.configure("Accent.TButton", font=("Arial", 10, "bold"))
        except:
            pass
    
    def load_saved_config(self):
        """–ó–∞—Ä–µ–∂–¥–∞ –∑–∞–ø–∞–∑–µ–Ω–∞—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"""
        config = self.config_manager.load_config()
        if config:
            self.email_entry.delete(0, tk.END)
            self.email_entry.insert(0, config.get('email', ''))
            
            self.password_entry.delete(0, tk.END)
            self.password_entry.insert(0, config.get('password', ''))
            
            output_dir = config.get('output_dir', '')
            if output_dir and os.path.exists(output_dir):
                self.output_dir = output_dir
                self.dir_label.config(text=output_dir)
            
            self.log_message("‚úì –ó–∞—Ä–µ–¥–µ–Ω–∏ –∑–∞–ø–∞–∑–µ–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏")
    
    def toggle_manual_login(self):
        """–ü—Ä–µ–≤–∫–ª—é—á–≤–∞ —Ä–µ–∂–∏–º–∞ –Ω–∞ —Ä—ä—á–Ω–æ –≤–ª–∏–∑–∞–Ω–µ"""
        self.manual_login_mode = self.manual_login_var.get()
        if self.manual_login_mode:
            self.log_message("üë§ –†–µ–∂–∏–º: –†—ä—á–Ω–æ –≤–ª–∏–∑–∞–Ω–µ - —â–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –≤–ª–µ–∑–µ—Ç–µ –≤ –±—Ä–∞—É–∑—ä—Ä–∞ —Å–∞–º–∏")
        else:
            self.log_message("ü§ñ –†–µ–∂–∏–º: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–ª–∏–∑–∞–Ω–µ")
    
    def choose_directory(self):
        """–ò–∑–±–∏—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ —Å—ä—Ö—Ä–∞–Ω–µ–Ω–∏–µ"""
        directory = filedialog.askdirectory(
            title="–ò–∑–±–µ—Ä–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ —Å—ä—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞ –±–µ–ª–µ–∂–∫–∏—Ç–µ",
            initialdir=self.output_dir
        )
        if directory:
            self.output_dir = directory
            self.dir_label.config(text=directory)
            self.log_message(f"‚úì –ò–∑–±—Ä–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {directory}")
    
    def log_message(self, message):
        """–î–æ–±–∞–≤—è —Å—ä–æ–±—â–µ–Ω–∏–µ –≤ –ª–æ–≥ —Ç–µ–∫—Å—Ç–∞"""
        def _log():
            self.log_text.insert(tk.END, message + "\n")
            self.log_text.see(tk.END)
        
        if threading.current_thread() != threading.main_thread():
            self.root.after(0, _log)
        else:
            _log()
    
    def update_status(self, message, color="black"):
        """–û–±–Ω–æ–≤—è–≤–∞ —Å—Ç–∞—Ç—É—Å –ª–µ–π–±—ä–ª–∞"""
        def _update():
            self.status_label.config(text=message, foreground=color)
        
        if threading.current_thread() != threading.main_thread():
            self.root.after(0, _update)
        else:
            _update()
    
    def start_download(self):
        """–°—Ç–∞—Ä—Ç–∏—Ä–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ—Ç–æ"""
        email = self.email_entry.get().strip()
        password = self.password_entry.get().strip()
        
        if not email:
            messagebox.showerror("–ì—Ä–µ—à–∫–∞", "–ú–æ–ª—è –≤—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ–π–ª!")
            return
        
        if not password and not self.manual_login_mode:
            messagebox.showerror("–ì—Ä–µ—à–∫–∞", "–ú–æ–ª—è –≤—ä–≤–µ–¥–µ—Ç–µ –ø–∞—Ä–æ–ª–∞ –∏–ª–∏ –∏–∑–±–µ—Ä–µ—Ç–µ —Ä–µ–∂–∏–º –Ω–∞ —Ä—ä—á–Ω–æ –≤–ª–∏–∑–∞–Ω–µ!")
            return
        
        if not os.path.exists(self.output_dir):
            messagebox.showerror("–ì—Ä–µ—à–∫–∞", "–ò–∑–±—Ä–∞–Ω–∞—Ç–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞!")
            return
        
        # –ó–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞
        if self.save_config_var.get():
            try:
                self.config_manager.save_config(email, password, self.output_dir)
                self.log_message("üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏")
            except Exception as e:
                self.log_message(f"‚ö† –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ: {e}")
        
        # –î–µ–∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–∏
        self.start_button.config(state=tk.DISABLED)
        self.stop_button.config(state=tk.NORMAL)
        self.email_entry.config(state=tk.DISABLED)
        self.password_entry.config(state=tk.DISABLED)
        self.dir_button.config(state=tk.DISABLED)
        
        # –ê–∫–æ –µ —Ä—ä—á–Ω–æ –≤–ª–∏–∑–∞–Ω–µ, –ø–æ–∫–∞–∑–≤–∞–º–µ –±—É—Ç–æ–Ω–∞ "–ü—Ä–æ–¥—ä–ª–∂–∏"
        if self.manual_login_mode:
            self.continue_button.config(state=tk.NORMAL)
        self.email_entry.config(state=tk.DISABLED)
        self.password_entry.config(state=tk.DISABLED)
        self.dir_button.config(state=tk.DISABLED)
        
        # –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ –ª–æ–≥–æ–≤–µ—Ç–µ
        self.log_text.delete(1.0, tk.END)
        
        # –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å –±–∞—Ä
        self.progress.start()
        self.update_status("–í –ø—Ä–æ—Ü–µ—Å –Ω–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ...", "orange")
        
        # –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ downloader
        self.downloader = LidlReceiptDownloader(
            email, 
            password, 
            self.output_dir,
            self.log_message,
            manual_login=self.manual_login_mode
        )
        
        # –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –≤ –æ—Ç–¥–µ–ª–Ω–∞ –Ω–∏—à–∫–∞
        self.download_thread = threading.Thread(target=self.run_download, daemon=True)
        self.download_thread.start()
    
    def run_download(self):
        """–ò–∑–ø—ä–ª–Ω—è–≤–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ—Ç–æ –≤ –æ—Ç–¥–µ–ª–Ω–∞ –Ω–∏—à–∫–∞"""
        try:
            # –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –Ω–æ–≤ event loop –∑–∞ —Ç–∞–∑–∏ –Ω–∏—à–∫–∞
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            
            # –ò–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ—Ç–æ
            loop.run_until_complete(self.downloader.download_all_receipts())
            
            # –ó–∞–ø–∞–∑–≤–∞–Ω–µ –Ω–∞ —Ñ–∞–π–ª–∞
            if self.downloader.receipts and not self.downloader.is_cancelled:
                file_path = self.downloader.save_to_file()
                self.root.after(0, lambda: messagebox.showinfo(
                    "–£—Å–ø–µ—Ö", 
                    f"–£—Å–ø–µ—à–Ω–æ –∏–∑—Ç–µ–≥–ª–µ–Ω–∏ {len(self.downloader.receipts)} –±–µ–ª–µ–∂–∫–∏!\n\n"
                    f"–§–∞–π–ª: {file_path}"
                ))
                self.update_status("‚úì –ó–∞–≤—ä—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ", "green")
            elif self.downloader.is_cancelled:
                self.update_status("‚ö† –ü—Ä–µ–∫—ä—Å–Ω–∞—Ç–æ", "orange")
                if self.downloader.receipts:
                    file_path = self.downloader.save_to_file()
                    self.root.after(0, lambda: messagebox.showwarning(
                        "–ü—Ä–µ–∫—ä—Å–Ω–∞—Ç–æ", 
                        f"–ü—Ä–æ—Ü–µ—Å—ä—Ç –±–µ—à–µ –ø—Ä–µ–∫—ä—Å–Ω–∞—Ç.\n"
                        f"–ó–∞–ø–∞–∑–µ–Ω–∏ {len(self.downloader.receipts)} –±–µ–ª–µ–∂–∫–∏.\n\n"
                        f"–§–∞–π–ª: {file_path}"
                    ))
            else:
                self.update_status("‚ö† –ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –±–µ–ª–µ–∂–∫–∏", "orange")
                self.root.after(0, lambda: messagebox.showwarning(
                    "–í–Ω–∏–º–∞–Ω–∏–µ", 
                    "–ù–µ —Å–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –∫–∞—Å–æ–≤–∏ –±–µ–ª–µ–∂–∫–∏.\n\n"
                    "–í—ä–∑–º–æ–∂–Ω–∏ –ø—Ä–∏—á–∏–Ω–∏:\n"
                    "- –ù—è–º–∞ –ø–æ–∫—É–ø–∫–∏ –≤ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞\n"
                    "- –ü—Ä–æ–±–ª–µ–º —Å –≤–ª–∏–∑–∞–Ω–µ—Ç–æ –≤ –∞–∫–∞—É–Ω—Ç–∞\n"
                    "- –°—Ç—Ä—É–∫—Ç—É—Ä–∞—Ç–∞ –Ω–∞ —Å–∞–π—Ç–∞ –µ –ø—Ä–æ–º–µ–Ω–µ–Ω–∞"
                ))
                
        except Exception as e:
            self.log_message(f"\n‚ùå –ì—Ä–µ—à–∫–∞: {e}")
            self.update_status("‚ùå –ì—Ä–µ—à–∫–∞", "red")
            self.root.after(0, lambda: messagebox.showerror(
                "–ì—Ä–µ—à–∫–∞", 
                f"–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑—Ç–µ–≥–ª—è–Ω–µ—Ç–æ:\n\n{str(e)}"
            ))
        finally:
            # –°–ø–∏—Ä–∞–Ω–µ –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å –±–∞—Ä –∏ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–∏
            self.root.after(0, self.reset_ui)
    
    def continue_after_login(self):
        """–ü—Ä–æ–¥—ä–ª–∂–∞–≤–∞ —Å–ª–µ–¥ —Ä—ä—á–Ω–æ –≤–ª–∏–∑–∞–Ω–µ"""
        if self.downloader:
            self.downloader.login_completed = True
            self.continue_button.config(state=tk.DISABLED)
            self.log_message("\n‚úì –ü—Ä–æ–¥—ä–ª–∂–∞–≤–∞–Ω–µ —Å –∏–∑—Ç–µ–≥–ª—è–Ω–µ –Ω–∞ –±–µ–ª–µ–∂–∫–∏...")
    
    def stop_download(self):
        """–ü—Ä–µ–∫—ä—Å–≤–∞ –∏–∑—Ç–µ–≥–ª—è–Ω–µ—Ç–æ"""
        if self.downloader:
            self.downloader.is_cancelled = True
            self.log_message("\n‚ö† –ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ —Å–∏–≥–Ω–∞–ª –∑–∞ –ø—Ä–µ–∫—ä—Å–≤–∞–Ω–µ...")
            self.stop_button.config(state=tk.DISABLED)
            self.continuemessage("\n‚ö† –ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ —Å–∏–≥–Ω–∞–ª –∑–∞ –ø—Ä–µ–∫—ä—Å–≤–∞–Ω–µ...")
            self.stop_button.config(state=tk.DISABLED)
    
    def reset_ui(self):
        """–í—Ä—ä—â–∞ UI –≤ –Ω–∞—á–∞–ª–Ω–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ"""
        self.progress.stop()
        self.start_button.config(state=tk.NORMAL)
        self.stop_button.config(state=tk.DISABLED)
        self.continue_button.config(state=tk.DISABLED)
        self.email_entry.config(state=tk.NORMAL)
        self.password_entry.config(state=tk.NORMAL)
        self.dir_button.config(state=tk.NORMAL)


def main():
    root = tk.Tk()
    app = LidlGUI(root)
    root.mainloop()


if __name__ == "__main__":
    main()
